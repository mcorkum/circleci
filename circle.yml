machine:
  timezone:
    America/Chicago

  environment:
    ngrok_url: calderadev.ngrok.io
    ngork_auth_token: d8NfARcu2wLE1hyeQd9J_6m4RuZQCCoKXJ3etDGnMv
    ngork_subdomain: calderadev

  php:
    version: 5.5.31

  # This will be added to the `/etc/hosts` file
  hosts:
    calderadev.ngrok.io: 127.0.0.1

general:
  artifacts:
    - "/var/log/apache2/"

dependencies:
  pre:
    # No password is required for the MySQL user `ubuntu`
    - mysql -e 'CREATE DATABASE wordpress;' -uroot

    # Use cURL to fetch WP-CLI
    - curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar

    # Make sure WP-CLI is executable
    - chmod +x wp-cli.phar
    - echo 'alias wp="php /home/ubuntu/wp-cli/wp-cli.phar"' >> ~/.bashrc
    - mv wp-cli.phar /home/ubuntu/wp-cli/
    - mv config.yml /home/ubuntu/wp-cli/
    - source ~/.bashrc

    # Download WordPress into `wordpress` directory
    - wp core download --allow-root --path=wordpress

    # Generate `wp-config.php` file
    - wp core config --allow-root --dbname=wordpress --dbuser=root --dbuser=root --dbhost=127.0.0.1

    # Install WordPress
    - wp core install --allow-root --admin_name=admin --admin_password=admin --admin_email=admin@example.com --url={$ngrok_url} --title=WordPress

    # Permalinks
    - wp rewrite structure '/%year%/%monthnum%/%postname%/' --hard

    # Install Caldera
    - wp plugin install caldera-forms

    # Install diff plugin
    - git clone https://gitlab.com/caldera-labs/cf-result-diff-plugin.git wordpress/wp-content/plugins/cf-result-diff-plugin
    # - ./wp-cli.phar plugin activate cf-result-diff-plugin --path=wordpress

    # Download ngrok and open tunnel to our application
    - wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
    - unzip ngrok-stable-linux-amd64.zip
    - chmod +x ngrok
    - ./ngrok authtoken ${ngork_auth_token}

    # Download json parser for determining ngrok tunnel
    - wget https://stedolan.github.io/jq/download/linux64/jq
    - chmod +x jq

  post:
    # Setup and restart apache
    - sudo unlink /usr/lib/apache2/modules/libphp5.so
    - sudo ln -s $PHPENV_ROOT/versions/$(phpenv global)/usr/lib/apache2/modules/libphp5.so /usr/lib/apache2/modules/libphp5.so
    - sudo cp ./apache-ci.conf /etc/apache2/sites-available/wordpress.conf
    - cd /etc/apache2/sites-available; sudo a2enmod rewrite; sudo service apache2 restart; sudo a2ensite wordpress; sudo service apache2 reload
    - ./ngrok http -subdomain=${ngork_subdomain} 8080:
        background: true

test:
  override:
    # This is just for us to see that the WP Pusher plugin was actually installed and is active
    - ./wp-cli.phar plugin list --path=wordpress